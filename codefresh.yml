version: '1.0'
steps:
  BuildingDockerImage:
    title: Build Docker Image
    type: build
    image_name: asabaylus/reactcommandpalette
    working_directory: ./
    tag: '${{CF_BRANCH_TAG_NORMALIZED}}'
    dockerfile: Dockerfile
    build_arguments:
      - CF_BRANCH=${{CF_BRANCH}}
      - NPM_TOKEN=${{NPM_TOKEN}}
  QualityChecks:
    type: parallel
    steps:
      UnitTest:
        title: Jest
        image: ${{BuildingDockerImage}}
        commands:
          - npm test
      Lint:
        title: ESlint
        image: ${{BuildingDockerImage}}
        commands:
          - npm run lint
      VisualRegression:
        title: Chromatic
        image: ${{BuildingDockerImage}}
        commands:
          - npm run prebuild:storybook
          - npm run chromatic
      Coverage:
        title: CodeCov & CodeClimate Coverage
        image: ${{BuildingDockerImage}}
        commands:
          - ./node_modules/.bin/codecov
          - cc-test-reporter after-build -t lcov --prefix "/codefresh/volume/react-command-palette" --exit-code $?
  PublishNPM:
    title: Publish to NPM
    image: ${{BuildingDockerImage
    build_arguments:
      - NPM_TOKEN=${{NPM_TOKEN}}
    commands:
      - npm publish --dry-run
    when:
      branch:
        only:
          - master
